version: 3

# Main Taskfile - Global tasks and inclusions
# Automatically loads variables from .env file if it exists
dotenv: [ '.env' ]

includes:
  docker: ./taskfiles/docker/Taskfile.yml
  utils: ./taskfiles/utils/Taskfile.yml
  env: ./taskfiles/env/Taskfile.yml
  nodejs: ./taskfiles/nodejs/Taskfile.yml
  download: ./taskfiles/download/Taskfile.yml
  apache: ./taskfiles/apache/Taskfile.yml
  lint: ./taskfiles/lint/Taskfile.yml

vars:
  # Variables with default values from .env or fallback values
  PROJECT_NAME: '{{.PROJECT_NAME | default "labstag"}}'
  ENVIRONMENT: '{{.ENVIRONMENT | default "development"}}'
  STACK_NAME: '{{.STACK | default "labstag"}}'
  FOLDERSQL: '{{.FOLDERSQL | default "database_init"}}'
  FILESQL: '{{.FILESQL | default "dump.sql"}}'
  FOLDERLAMPY: '{{.FOLDERLAMPY | default "lampy"}}'
  SERVERNAME: '{{.SERVERNAME | default "labstag.traefik.me"}}'
  DOCKERCOMPOSEFILE: '{{.DOCKERCOMPOSEFILE | default "docker-compose.yml"}}'

tasks:
  default:
    desc: "Display help and available tasks"
    silent: true
    cmds:
    - echo "üõ†Ô∏è  Collection of Taskfiles for development"
    - echo ""
    - echo "Available global tasks:"
    - task --list
    - echo ""

  info:
    desc: "Display project information with environment variables"
    silent: true
    cmds:
    - |
      export PROJECT_VERSION=$(jq -r .version package.json)
      echo "üõ†Ô∏è  {{.PROJECT_NAME}} v$PROJECT_VERSION - Collection of Taskfiles"
      echo "Environment: {{.ENVIRONMENT}}"

  help:
    desc: "Display detailed help"
    aliases: [ h ]
    cmds:
    - task: default

  labstag:fix-permissions:
    desc: "Fix Labstag file permissions (manual use if necessary)"
    silent: true
    cmds:
    - chmod -R 755 ./apps
    - chmod -R 777 ./apps/var
    - chmod -R 777 ./apps/public/uploads

  labstag:getapacheconf:
    desc: "Retrieve Apache configuration from Docker image"
    silent: true
    cmds:
    - rm -rf ./conf/apache2 || true
    - mkdir -p ./conf/apache2
    - task docker:create CONTAINER_NAME=labstagphp IMAGE_NAME=$(awk '/www:/ {f=1} f && /image:/ {print $2; exit}' {{.DOCKERCOMPOSEFILE}})
    - task: docker:getfile
      vars:
        CONTAINER_NAME: "labstagphp"
        FILE_PATH: "/etc/apache2/sites-available/000-default.conf"
        DEST_PATH: "./conf/apache2/000-default.conf"
    - task: docker:getfile
      vars:
        CONTAINER_NAME: "labstagphp"
        FILE_PATH: "/etc/apache2/apache2.conf"
        DEST_PATH: "./conf/apache2/apache2.conf"
    - docker rm -f labstagphp
    - task: apache:updateconfig
      vars:
        SERVERNAME: "{{.SERVERNAME}}"
        APACHE_DOCUMENT_ROOT: "/var/www/public"

  labstag:copysql:
    desc: "Copy SQL dump file to labstag folder"
    silent: true
    cmds:
    - task: utils:file:copy
      vars:
        SOURCE_FILE: ./{{.FOLDERSQL}}/{{.FILESQL}}
        DEST_DIR: "{{.FOLDERLAMPY}}/mariadb_init/"
        FORCE: true

  labstag:getpull-image:
    desc: "Download Docker images defined in docker-compose.yml"
    silent: true
    cmds:
    - task: docker:images:pull
      vars:
        COMPOSE_FILE: "{{.DOCKERCOMPOSEFILE}}"

  labstag:deploy:
    desc: "Deploy Docker stacks defined in docker-compose files"
    silent: true
    cmds:
    - task: docker:stack:deploy
      vars:
        COMPOSE_FILE: "{{.DOCKERCOMPOSEFILE}}"
        STACK_NAME: "{{.STACK_NAME}}"

  labstag:install-first:
    desc: "Initial installation of Composer and dependencies"
    silent: false
    cmds:
    - docker run --rm -v $(pwd)/apps:/var/www -w /var/www $(awk '/www:/ {f=1} f && /image:/ {print $2; exit}' {{.DOCKERCOMPOSEFILE}}) symfony composer install

  labstag:waiting:
    desc: "Wait for services to be operational"
    silent: true
    cmds:
    - task: docker:stack:check:containers:ready
      vars:
        CONTAINERS: "www"
        STACK_NAME: "{{.STACK_NAME}}"

  labstag:ls:
    desc: "List Docker stacks and services"
    silent: true
    cmds:
    - task: docker:stack:services
      vars:
        STACK_NAME: "{{.STACK_NAME}}"

  labstag:exec:
    desc: "Execute a command in a running container"
    cmds:
    - task: labstag:set-env-ids
    - task: labstag:copysql
    - task: labstag:getpull-image
    - task: labstag:getapacheconf
    - task: labstag:deploy
    - task: labstag:waiting
    - task: labstag:ls

  labstag:download-phar:
    desc: "Download various phar files"
    cmds:
    - task: download:php:tools
      vars:
        TOOLS_DIR: ./../apps

  labstag:bash:
    desc: "Open a bash shell in the www container"
    preconditions:
    - sh: docker service ls | grep -q {{.STACK_NAME}}_www
      msg: "Docker service {{.STACK_NAME}}_www is not started. Run 'task labstag:deploy' first"
    cmds:
    - task: docker:stack:shell
      vars:
        STACK_NAME: "labstag"
        SERVICE_NAME: "www"

  labstag:cmd-exec:
    desc: "Execute a command in the Docker container"
    silent: true
    vars:
      INTERACTIVE: '{{.INTERACTIVE | default "true"}}'
    preconditions:
    - sh: docker service ls | grep -q {{.STACK_NAME}}_www
      msg: "Docker service {{.STACK_NAME}}_www is not started. Run 'task labstag:deploy' first"
    cmds:
    - task: docker:stack:exec
      vars:
        STACK_NAME: "labstag"
        SERVICE_NAME: "www"
        COMMAND: "{{.COMMAND}}"
        INTERACTIVE: "{{.INTERACTIVE}}"

  symfony:about:
    desc: "Show Symfony information"
    silent: true
    cmds:
    - task: symfony:console
      vars:
        CMD: "about"

  symfony:console:
    desc: "Execute a Symfony command"
    internal: true
    silent: true
    preconditions:
    - sh: docker service ls | grep -q {{.STACK_NAME}}_www
      msg: "Docker service {{.STACK_NAME}}_www is not started. Run 'task labstag:deploy' first"
    vars:
      CMD: '{{.CMD | default ""}}'
      # Disable interactivity in CI/CD environment
      INTERACTIVE: '{{if or (eq (env "DOCKER_INTERACTIVE") "false") (eq (env "CI") "true") (eq (env "GITHUB_ACTIONS") "true")}}false{{else}}true{{end}}'
    cmds:
    - task: labstag:cmd-exec
      vars:
        COMMAND: "symfony console {{.CMD}}"

  labstag:assets:
    desc: "Install Symfony assets"
    silent: true
    cmds:
    - task: symfony:console
      vars:
        CMD: "assets:install public --symlink --relative"

  labstag:cache-clear:
    desc: "Clear Symfony cache"
    silent: true
    cmds:
    - task: symfony:console
      vars:
        CMD: "cache:clear"

  composer:exec:
    desc: "Execute a Composer command"
    silent: true
    vars:
      CMD: '{{.CMD | default ""}}'
    cmds:
    - task: labstag:cmd-exec
      vars:
        COMMAND: "symfony composer {{.CMD}}"

  composer:fund:
    desc: "Show funding links of Composer dependencies"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "fund"

  composer:install:
    desc: "Install Composer dependencies"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "install"

  composer:outdated:
    desc: "Show outdated dependencies"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "outdated"

  composer:suggests:
    desc: "Show Composer dependency suggestions"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "suggests"

  composer:update:
    desc: "Update Composer dependencies"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "update"

  doctrine:fixtures:
    desc: "Load Doctrine fixtures"
    silent: true
    cmds:
    - task: symfony:console
      vars:
        CMD: "doctrine:fixtures:load --no-interaction"

  doctrine:migrate:
    desc: "Execute Doctrine migrations"
    silent: true
    cmds:
    - task: symfony:console
      vars:
        CMD: "doctrine:migrations:migrate -n"

  doctrine:schema:update:
    desc: "Update database schema"
    silent: true
    cmds:
    - task: symfony:console
      vars:
        CMD: "doctrine:schema:update --dump-sql --force"

  doctrine:schema:validate:
    desc: "Validate database schema"
    silent: true
    cmds:
    - task: symfony:console
      vars:
        CMD: "doctrine:schema:validate"

  composer:validate:
    desc: "Validate composer.json file"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "validate"

  composer:install:dev:
    desc: "Install Composer dependencies for development"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "install --no-progress --prefer-dist --optimize-autoloader"

  composer:install:prod:
    desc: "Install Composer dependencies for production"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "install --no-progress --prefer-dist --optimize-autoloader --no-dev"

  ecs-check:
    desc: "Check code with PHP CS Fixer"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "run ecs-check"

  ecs-fix:
    desc: "Fix code with PHP CS Fixer"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "run ecs-fix"

  labstag:geocode-install:
    desc: "Install geocoding data"
    silent: true
    vars:
      COUNTRY: '{{.COUNTRY | default ""}}'
    cmds:
    - task: symfony:console
      vars:
        CMD: "labstag:geocode-install {{.COUNTRY}}"

  lint:container:
    desc: "Check service configuration file syntax"
    silent: true
    cmds:
    - task: symfony:console
      vars:
        CMD: "lint:container"

  lint:php-cs-fixer:
    desc: "Check code with PHP CS Fixer"
    silent: true
    cmds:
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php -d memory_limit=-1 bin/php-cs-fixer fix src"

  lint:php-cs-fixer:dry:
    desc: "Check code with PHP CS Fixer in dry-run mode"
    silent: true
    cmds:
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php -d memory_limit=-1 bin/php-cs-fixer fix src --dry-run -v --diff"

  lint:phpcbf:
    desc: "Fix code with PHP Code Beautifier and Fixer"
    silent: true
    cmds:
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php -d memory_limit=-1 bin/phpcbf -d memory_limit=-1 --report=diff -p --extensions=php --standard=phpcs.xml"

  lint:phpcs:
    desc: "Check code with PHP CodeSniffer"
    silent: true
    cmds:
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php -d memory_limit=-1 bin/phpcs --report=full --extensions=php src --standard=phpcs.xml"

  lint:phpcs:error:
    desc: "Check code with PHP CodeSniffer and show only errors"
    silent: true
    cmds:
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php -d memory_limit=-1 bin/phpcs  --report=full --extensions=php --warning-severity=0 --standard=phpcs.xml"

  lint:phpcs:warning:
    desc: "Check code with PHP CodeSniffer and show only warnings"
    silent: true
    cmds:
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php -d memory_limit=-1 bin/phpcs --report=full --extensions=php --error-severity=0 --standard=phpcs.xml"

  lint:phpdoc:
    desc: "Check PHPDoc annotations with phpDocumentor"
    silent: true
    cmds:
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php -d memory_limit=-1 phpDocumentor.phar -d src -t public/docs"

  lint:phploc:
    desc: "Analyze code complexity with phploc"
    silent: true
    cmds:
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php -d memory_limit=-1 phploc.phar src"

  phpstan:
    desc: "Analyze code with PHPStan"
    silent: true
    vars:
      LEVEL: '{{.LEVEL | default "0"}}'
    cmds:
    - task: labstag:cmd-exec
      vars:
        COMMAND: "bin/phpstan analyse -l {{.LEVEL}}"

  lint:twig:
    desc: "Check Twig templates"
    silent: true
    cmds:
    - task: symfony:console
      vars:
        CMD: "lint:twig templates"

  messenger:consume:
    desc: "Start Messenger message consumer"
    silent: true
    cmds:
    - task: symfony:console
      vars:
        CMD: "messenger:consume --all"

  messenger:stats:
    desc: "Show Messenger statistics"
    silent: true
    cmds:
    - task: symfony:console
      vars:
        CMD: "messenger:stats"

  rector:
    desc: "Refactor code with Rector"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "run rector"

  rector:dry:
    desc: "Refactor code with Rector in dry-run mode"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "run rector-dry"

  star:get:
    desc: "Download star data"
    silent: true
    cmds:
    - gh api --paginate /user/starred --jq '.' | jq -s > apps/private/stars.json

  star:add:
    desc: "Add star data"
    silent: true
    cmds:
    - task: symfony:console
      vars:
        CMD: "labstag:star-add"

  star:
    desc: "Download and update star data"
    silent: true
    cmds:
    - task: star:get
    - task: star:add

  test:phpunit:
    desc: "Run PHPUnit tests"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "run simple-phpunit"

  test:phpunit:unit-integration:
    desc: "Run PHPUnit unit and integration tests"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "run simple-phpunit-unit-integration"

  translation:
    desc: "Manage translations with Symfony"
    silent: true
    vars:
      LOCALE: '{{.LOCALE | default "fr"}}'
    cmds:
    - task: symfony:console
      vars:
        CMD: "translation:extract --force {{.LOCALE}}"

  workflow:dump:
    desc: "Generate entity workflow in PNG format via temporary DOT file"
    internal: true
    silent: true
    vars:
      ENTITY: '{{.ENTITY | default "chapter"}}'
      FILE: '{{.ENTITY}}.png'
      DOT_FILE: '{{.ENTITY}}.dot'
    cmds:
    - task: labstag:cmd-exec
      vars:
        COMMAND: "sh -c 'symfony console workflow:dump {{.ENTITY}} > {{.DOT_FILE}}'"
    - task: labstag:cmd-exec
      vars:
        COMMAND: "sh -c 'dot -Tpng {{.DOT_FILE}} -o {{.FILE}}'"
    - task: labstag:cmd-exec
      vars:
        COMMAND: "rm {{.DOT_FILE}} && echo 'Temporary DOT file deleted'"

  workflow:dump:all:
    desc: "Show workflows for all entities"
    silent: true
    vars:
      ENTITIES: "chapter,edito,story,memo,post,page,user"
    cmds:
    - echo "üöÄ Generating all workflows..."
    - echo ""
    - for: { var: ENTITIES, split: ',' }
      task: workflow:dump
      vars:
        ENTITY: "{{.ITEM}}"
    - echo ""
    - echo "üéâ Generation completed!"
    ignore_error: true

  lint:all:
    desc: "Run all available linters"
    silent: true
    vars:
      SKIP_DOCKER: '{{.SKIP_DOCKER | default "false"}}'
    cmds:
    - task: lint:yml
      vars:
        IGNORE_DIR: "lampy,taskfiles,apps/vendor"
    - task: lint:md
      vars:
        IGNORE_DIR: "lampy,taskfiles"
    - task: lint:action
    - |
      if [ "{{.SKIP_DOCKER}}" = "true" ]; then
        echo "‚è≠  Skip lint:docker"
      else
        task lint:docker DOCKERCOMPOSEFILE="{{.DOCKERCOMPOSEFILE}}"
      fi
    - task: cmd:validate_outdated
    - npm run eslint
    - npm run lint:stylelint
    - task: lint:twig
    - task: lint:container
    - task: lint:phpaudit

  quality:all:
    desc: "Run all quality checks: linters + tests + static analysis"
    cmds:
    - echo "üîç Complete quality checks in progress..."
    - task: lint:all
    - task: test:all
    - task: phpstan:5
    - echo "‚úÖ Quality checks completed!"

  quality:ci:
    desc: "Quality checks for continuous integration"
    cmds:
    - echo "üîÑ CI quality checks in progress..."
    - task: lint:phpaudit
    - task: test:quick
    - task: phpstan:8
    - echo "‚úÖ CI quality checks completed!"

  fix:all:
    desc: "Automatically fix code issues"
    silent: true
    cmds:
    - npm run eslint:fix
    - npm run lint:stylelint:fix
    - task: ecs-fix
    - task: lint:phpcbf
    - task: lint:phpcs
    - task: rector
    ignore_error: true

  lint:phpaudit:
    desc: "Analyze code with PHP Audit"
    silent: true
    cmds:
    - task: lint:phpcs:error
    - task: phpstan
      vars:
        LEVEL: "0"

  cmd:validate_outdated:
    desc: "Validate outdated dependencies"
    silent: true
    cmds:
    - task: composer:validate
    - task: composer:outdated

  cmd:install:all:
    desc: "Install all dependencies and run migrations"
    silent: true
    cmds:
    - task: doctrine:migrate
    - task: labstag:assets
    - npm run encore:dev

  cmd:install:bdd:
    desc: "Install database with fixtures"
    silent: true
    cmds:
    - task: doctrine:fixtures

  cmd:install:dev:
    desc: "Install complete development environment"
    silent: true
    cmds:
    - task: download:phar
    - task: cmd:install:all
    - task: cmd:install:bdd

  cmd:install:prod:
    desc: "Install complete production environment"
    silent: true
    cmds:
    - task: cmd:install:all
    - task: cmd:install:bdd
    - npm run encore:build

  data:
    desc: "Install demonstration data"
    silent: true
    cmds:
    - task: doctrine:fixtures
    - task: star:add

  labstag:set-env-ids:
    desc: "Update UID/GID in .env file"
    silent: true
    cmds:
    - |
      if ! grep -q "UID=" .env; then
        echo "UID=$(id -u)" >> .env
      else
        sed -i "s/UID=.*/UID=$(id -u)/" .env
      fi
    - |
      if ! grep -q "GID=" .env; then
        echo "GID=$(id -g)" >> .env
      else
        sed -i "s/GID=.*/GID=$(id -g)/" .env
      fi

  # =====================================
  # T√ÇCHES DE TESTS (DOCKER ONLY)
  # =====================================

  test:setup:
    desc: "Prepare test environment in container"
    silent: true
    cmds:
    - echo "üîß Preparing test environment..."
    - echo "‚ÑπÔ∏è  Using SQLite file database for tests"
    - task: labstag:cmd-exec
      vars:
        COMMAND: "rm -f var/test.db"
        INTERACTIVE: "false"
    - task: symfony:console
      vars:
        CMD: "doctrine:schema:update --env=test --force"
    - task: symfony:console
      vars:
        CMD: "doctrine:fixtures:load --env=test --no-interaction"
    - echo "‚úÖ Test environment ready"

  test:unit:
    desc: "Run unit tests"
    silent: true
    cmds:
    - echo "üß™ Running unit tests..."
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php bin/phpunit --testsuite=unit --colors=always"
        INTERACTIVE: "false"
    - echo "‚úÖ Unit tests completed"

  test:integration:
    desc: "Run integration tests"
    silent: true
    cmds:
    - echo "üîó Running integration tests..."
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php bin/phpunit --testsuite=integration --colors=always"
        INTERACTIVE: "false"
    - echo "‚úÖ Integration tests completed"

  test:functional:
    desc: "Run functional tests"
    silent: true
    cmds:
    - echo "üåê Running functional tests..."
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php bin/phpunit --testsuite=functional --colors=always"
        INTERACTIVE: "false"
    - echo "‚úÖ Functional tests completed"

  test:performance:
    desc: "Run performance tests"
    silent: true
    cmds:
    - echo "‚ö° Running performance tests..."
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php bin/phpunit --testsuite=performance --colors=always"
        INTERACTIVE: "false"
    - echo "‚úÖ Performance tests completed"

  test:coverage:
    desc: "Generate code coverage report"
    silent: true
    cmds:
    - echo "üìä Generating coverage report..."
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php bin/phpunit --coverage-html var/coverage --colors=always"
        INTERACTIVE: "false"
    - echo "‚úÖ Coverage report generated in var/coverage/"

  test:all:
    desc: "Run all tests (unit, integration, functional, performance)"
    silent: true
    cmds:
    - echo "üöÄ Running all tests..."
    - task: test:setup
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php bin/phpunit --colors=always"
        INTERACTIVE: "false"
    - task: test:cleanup
    - echo "‚úÖ All tests completed successfully"

  test:cleanup:
    desc: "Clean up test environment"
    silent: true
    cmds:
    - echo "üßπ Cleaning up test environment..."
    - task: labstag:cmd-exec
      vars:
        COMMAND: "rm -f var/test.db"
        INTERACTIVE: "false"
    - echo "‚úÖ Test environment cleaned"

  test:quick:
    desc: "Run only unit tests (fast)"
    silent: true
    cmds:
    - echo "‚ö° Quick tests (unit only)..."
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php bin/phpunit --testsuite=unit --colors=always --stop-on-failure"
        INTERACTIVE: "false"
    - echo "‚úÖ Quick tests completed"

  test:watch:
    desc: "Run tests in watch mode (file monitoring)"
    silent: true
    preconditions:
    - sh: command -v inotifywait
      msg: "inotify-tools is not installed. Install it with 'sudo apt install inotify-tools'"
    cmds:
    - echo "üëÄ Test watch mode activated (Ctrl+C to stop)..."
    - |
      while true; do
        inotifywait -r -e modify apps/src/ apps/tests/ --exclude=".*\.git.*|.*\.cache.*|.*var.*" -q
        echo "üîÑ File modified, rerunning tests..."
        task labstag:cmd-exec COMMAND="php bin/phpunit --testsuite=unit --colors=always --stop-on-failure" INTERACTIVE=false
      done

  test:debug:
    desc: "Run tests with detailed debugging information"
    silent: true
    cmds:
    - echo "üêõ Running tests in debug mode..."
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php bin/phpunit --debug --colors=always"
        INTERACTIVE: "false"

  test:validate:
    desc: "Validate test configuration"
    silent: true
    cmds:
    - echo "‚úÖ Validating test configuration..."
    - task: labstag:cmd-exec
      vars:
        COMMAND: "php bin/phpunit --list-tests"
        INTERACTIVE: "false"
    - task: symfony:console
      vars:
        CMD: "lint:container --env=test"
    - task: symfony:console
      vars:
        CMD: "doctrine:schema:validate --env=test"
    - echo "‚úÖ Test configuration is valid"

